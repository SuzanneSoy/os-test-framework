language: c
addons:
  apt:
    packages:
      - scrot
      - qemu
      - qemu-system-x86
      - qemu-system-arm
      #- virtualbox
      - bochs-sdl
      - sikuli-ide
      # Missing dependencies for sikuli-ide
      #- libantlr3-runtime-java # on 16.04
      - antlr3 # on 14.04
      #- jaffl-java # unavailable on Travis
      - libjna-java
      - libcommons-cli-java
      - libjson-simple-java
      - libdc1394-22
      - libdc1394-22-dev
      - wmctrl
      # example-os build dependencies:
      - nasm

matrix:
  include:
    # Thanks to https://keyholesoftware.com/2012/12/05/building_vagrant_boxes_with_veewee_on_travis/ for making me realize that VirtualBox will actually work with sudo
    - env: MODE=qemu-system-i386
      sudo: false
    - env: MODE=qemu-system-arm
      sudo: false
    - env: MODE=virtualbox
      sudo: true
    - env: MODE=bochs
      sudo: false

install:
  - for i in 0 1; do for j in `seq 0 7`; do echo -ne "\033[${i};3${j}m█"; done; done
  - for i in 0 1; do for j in `seq 0 7`; do echo -ne "\033[${i};4${j}m█"; done; done
  - for j in `seq 0 255`; do echo -ne "\033[38;5;${j}m█"; done
  - for j in `seq 0 255`; do echo -ne "\033[48;5;${j}m█"; done
  # The sikuli-ide packaged with ubuntu 16.04 does not seem to work correctly: missing dependencies, some dependencies are too recent, …
  - mkdir ~/sikulix/
  - wget https://launchpadlibrarian.net/359997648/sikulixsetup-1.1.2.jar -O ~/sikulix/sikulixsetup-1.1.2.jar
  - (cd ~/sikulix && java -jar sikulixsetup-1.1.2.jar options 1 1.1)
  - export PATH="$HOME/sikulix/:$PATH"
  - |
    if test "$MODE" = virtualbox; then
      echo "deb https://download.virtualbox.org/virtualbox/debian $(lsb_release --short --codename) contrib" | sudo tee /etc/apt/sources.list.d/virtualbox.list
      sudo apt-get update
      sudo apt-get -y install virtualbox "linux-headers-$(uname -r)"
    fi

script:
  - (cd example-os && make)
  - xvfb-run -a ./test/${MODE}.sh
